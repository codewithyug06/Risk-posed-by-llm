<!-- Chosen Palette: Dark Professional Theme (Deep Slate/Violet Accents) -->
<!-- Application Structure Plan: The structure uses a responsive dashboard layout optimized for real-time threat monitoring (SOC context). The top tier focuses on immediate metrics (Risk Score, Latency). The left panel is the interactive input/control center (Simulations, Red-Team). The central area is dominated by the dynamic GNN Visualization (most complex feature). The right panel and lower cards provide XAI, Narrative Synthesis (Gemini), and Policy/Mitigation actions (Blockchain/Sharing Mock). This task-oriented, single-page flow allows judges to quickly understand the threat, analyze the technical justification, and see the mitigation workflow. -->
<!-- Visualization & Content Choices: GNN Propagation Map -> Goal: Relationship/Organization -> Viz/Presentation Method: D3.js/Chart.js Scatter with dynamic line links -> Interaction: Node hover for detail -> Justification: Clearly visualizes multi-user coordination and sequential risk, core of the GNN model. XAI Features (Perplexity, Burstiness) -> Goal: Explain -> Viz/Presentation Method: Key Metric Cards/Text -> Interaction: N/A -> Justification: Provides technical evidence required for Explainability-First security. Narrative Analysis (Gemini) -> Goal: Inform/Synthesize -> Viz/Presentation Method: Text Block -> Interaction: N/A -> Justification: Translates raw data into actionable intelligence (policy layer). Custom Gauges/Alerts -> Goal: Inform/Compare -> Viz/Presentation Method: HTML/CSS/Tailwind -> Interaction: N/A -> Justification: Gives immediate, high-impact assessment. CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AegisAI - National LLM Escalation Risk Framework</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --color-bg-primary: #121212;
            --color-bg-secondary: #1e1e1e;
            --color-text-primary: #e0e0e0;
            --color-accent: #8b5cf6; /* Violet-500 */
            --color-critical: #ef4444; /* Red-500 */
            --color-high: #f97316;    /* Orange-500 */
            --color-low: #10b981;     /* Emerald-500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg-primary);
            color: var(--color-text-primary);
        }
        .card {
            background-color: var(--color-bg-secondary);
            border: 1px solid #2d2d2d;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .gauge-ring {
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 1s ease-in-out, stroke 0.5s;
        }
        .chart-container-wrapper {
            /* Ensures Chart.js canvas is constrained and responsive */
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            min-height: 400px;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 900px; /* Maximize graph space */
            height: 100%;
            min-height: 350px;
            max-height: 60vh; /* Responsive max height */
        }
        @media (max-width: 768px) {
             .chart-container {
                min-height: 300px;
                max-height: 50vh;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="p-4 sm:p-8">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center pb-6 border-b border-gray-700/50 mb-6">
            <h1 class="text-3xl font-extrabold flex items-center text-white">
                <span class="text-violet-500 mr-2">üõ°Ô∏è</span> AegisAI: National LLM Escalation Framework
            </h1>
            <div id="mode-indicator" class="mt-2 md:mt-0 px-3 py-1 text-sm font-semibold rounded-full bg-red-800 text-white shadow-lg">
                <span class="animate-pulse">üî¥ FALLBACK MODE</span>
            </div>
        </header>

        <!-- Main Dashboard Grid -->
        <main class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <!-- Left Panel: Input, Red-Team, and Controls -->
            <section class="lg:col-span-1 space-y-6">
                <div class="card p-5 rounded-xl">
                    <h2 class="text-xl font-bold mb-4 flex items-center text-gray-200">
                        <span class="mr-2 text-violet-400">‚öôÔ∏è</span> Threat Scenario Builder
                    </h2>
                    <p class="text-sm text-gray-400 mb-4">Define sequential, multi-user prompts to test the GNN's ability to detect coordinated risks.</p>
                    
                    <div id="user-inputs" class="space-y-4 mb-6 text-sm">
                        <!-- User Input Group 1 (Main Target for De-obfuscation) -->
                        <div class="user-group border-l-4 border-violet-500 pl-3">
                            <label class="block text-gray-400">User A (Initial Threat Agent ID: U001)</label>
                            <div class="flex space-x-2">
                                <input id="prompt-input-u001" type="text" placeholder="Prompts (comma-separated, e.g., prompt1, prompt2)" value="Explain how encryption works, What is the default password for admin?" class="prompt-input w-full mt-1 p-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-violet-500 focus:border-violet-500 text-gray-200">
                                <button onclick="handleDeobfuscation('prompt-input-u001')" class="mt-1 px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition duration-200 text-xs font-semibold whitespace-nowrap self-start">
                                    ‚ú® De-obfuscate
                                </button>
                            </div>
                        </div>
                        
                        <!-- User Input Group 2 -->
                        <div class="user-group border-l-4 border-red-500 pl-3">
                            <label class="block text-gray-400">User B (Coordinated Agent ID: U002)</label>
                            <input type="text" placeholder="Prompts (comma-separated)" value="What's the weather today?, Find the backdoor exploit for admin access" class="prompt-input w-full mt-1 p-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-violet-500 focus:border-violet-500 text-gray-200">
                        </div>
                        
                        <!-- User Input Group 3 (Optional) -->
                        <div class="user-group border-l-4 border-gray-500 pl-3">
                            <label class="block text-gray-400">User C (Potential Bot ID: U003)</label>
                            <input type="text" placeholder="Prompts (comma-separated, optional)" value="Explain Python, Tell me a joke" class="prompt-input w-full mt-1 p-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-violet-500 focus:border-violet-500 text-gray-200">
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="handleGNNAnalysis(false)" id="analyze-button" class="w-full bg-violet-600 hover:bg-violet-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md shadow-violet-800/50">
                            RUN GNN ESCALATION ANALYSIS
                        </button>
                        <button onclick="runRedTeamSimulation()" id="red-team-button" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md shadow-red-800/50">
                            <span class="mr-2">üí£</span> RED-TEAM SIMULATION
                        </button>
                    </div>
                </div>
            </section>

            <!-- Center & Top Right: Metrics, Visualization, and Explainability -->
            <section class="lg:col-span-3 space-y-6">
                <!-- Top Metrics Row -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    
                    <!-- 1. Escalation Risk Gauge -->
                    <div class="card p-4 rounded-xl flex flex-col items-center">
                        <h3 class="text-sm font-medium text-gray-400 mb-2">GNN ESCALATION SCORE</h3>
                        <div class="relative w-20 h-20">
                            <svg class="w-full h-full" viewBox="0 0 100 100">
                                <circle class="text-gray-700 stroke-current" stroke-width="8" cx="50" cy="50" r="40" fill="transparent"></circle>
                                <circle id="risk-gauge" class="gauge-ring stroke-current" stroke-width="8" cx="50" cy="50" r="40" fill="transparent" stroke-dasharray="251.2" stroke-dashoffset="251.2"></circle>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span id="group-risk-score" class="text-xl font-bold text-white">0.00</span>
                            </div>
                        </div>
                        <p id="escalation-alert" class="text-lg font-bold mt-2 text-green-400">LOW</p>
                    </div>

                    <!-- 2. GNN Latency -->
                    <div class="card p-4 rounded-xl flex flex-col items-center justify-center">
                        <h3 class="text-sm font-medium text-gray-400 mb-2">ANALYTICS LATENCY (ms)</h3>
                        <p id="latency-metric" class="text-3xl font-bold text-gray-200">0</p>
                        <p class="text-xs text-gray-500 mt-1">Real-Time Constraint: 300ms</p>
                    </div>

                    <!-- 3. GNN Coordination Score -->
                    <div class="card p-4 rounded-xl flex flex-col items-center justify-center">
                        <h3 class="text-sm font-medium text-gray-400 mb-2">COORDINATION SIGNAL (Avg Edge Wt)</h3>
                        <p id="coordination-metric" class="text-3xl font-bold text-gray-200">0.0000</p>
                        <p class="text-xs text-gray-500 mt-1">GNN input metric</p>
                    </div>
                    
                    <!-- 4. Federated Sharing Mock -->
                    <div class="card p-4 rounded-xl flex flex-col items-center justify-center space-y-2">
                        <h3 class="text-sm font-medium text-gray-400 mb-2">CROSS-BORDER INTELLIGENCE</h3>
                        <button id="share-button" onclick="shareIntel()" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-semibold py-2 px-4 rounded-md transition duration-200 shadow-md shadow-indigo-800/50">
                            üåê SHARE VIA FEDERATED API
                        </button>
                        <p id="share-status" class="text-xs text-gray-500 mt-1">Audit log initialized.</p>
                    </div>
                </div>

                <!-- Visualization Area -->
                <div class="card rounded-xl">
                    <h2 class="text-xl font-bold p-5 pb-0 flex items-center text-gray-200">
                        <span class="mr-2 text-violet-400">üï∏Ô∏è</span> GNN Propagation Map (Escalation Visualization)
                    </h2>
                    <p class="text-sm text-gray-400 px-5 pt-2 pb-4">Nodes are individual prompts; edges show temporal (user sequence) or semantic (cross-user coordination) links. Node color reflects LLM Risk Score (Red = High Risk).</p>
                    <div class="chart-container-wrapper">
                        <div class="chart-container">
                            <canvas id="gnn-graph"></canvas>
                        </div>
                        <p id="graph-status" class="text-sm text-gray-500 p-2">Awaiting analysis...</p>
                    </div>
                </div>
            </section>
            
            <!-- Bottom Row: XAI & Narrative -->
            <section class="lg:col-span-4 grid grid-cols-1 md:grid-cols-3 gap-6">
                
                <!-- 1. Explainable AI (XAI) Panel -->
                <div class="card p-5 rounded-xl md:col-span-1">
                    <h2 class="text-xl font-bold mb-4 flex items-center text-gray-200">
                        <span class="mr-2 text-green-400">üîç</span> XAI Stylometric Forensics
                    </h2>
                    <p class="text-sm text-gray-400 mb-4">Features extracted from the collective prompt text to determine AI origin and behavioral patterns. (B. AI Detection Engine)</p>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between items-center border-b border-gray-800 pb-2">
                            <span class="font-medium text-gray-400">Attributed LLM Model:</span>
                            <span id="xai-model" class="font-bold text-violet-400">N/A</span>
                        </div>
                        <div class="flex justify-between items-center border-b border-gray-800 pb-2">
                            <span class="font-medium text-gray-400">Perplexity Score (Entropy):</span>
                            <span id="xai-perplexity" class="font-bold text-gray-300">0.00</span>
                        </div>
                        <div class="flex justify-between items-center border-b border-gray-800 pb-2">
                            <span class="font-medium text-gray-400">Burstiness Index:</span>
                            <span id="xai-burstiness" class="font-bold text-gray-300">0.000</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-gray-400">Linguistic Regularity:</span>
                            <span id="xai-regularity" class="font-bold text-gray-300">N/A</span>
                        </div>
                    </div>
                </div>

                <!-- 2. Gemini Narrative Synthesis & Mitigation -->
                <div class="card p-5 rounded-xl md:col-span-2">
                    <h2 class="text-xl font-bold mb-4 flex items-center text-gray-200">
                        <span class="mr-2 text-blue-400">üß†</span> Threat Narrative & Prescriptive Defense (Gemini)
                    </h2>
                    <div class="space-y-4">
                        <div class="p-3 bg-gray-700/50 rounded-lg">
                            <h3 class="text-sm font-semibold text-gray-300 mb-1">MALIGN NARRATIVE IDENTIFIED:</h3>
                            <p id="narrative-summary" class="text-base font-medium text-gray-200 italic">Awaiting Gemini analysis...</p>
                        </div>
                        <div class="p-3 bg-red-900/40 border border-red-700/50 rounded-lg">
                            <h3 class="text-sm font-semibold text-red-300 mb-1">MITIGATION ACTION RECOMMENDED:</h3>
                            <p id="mitigation-action" class="text-base text-red-200 font-medium">Run analysis to generate prescriptive action.</p>
                        </div>
                        <div class="p-3 bg-gray-700/50 rounded-lg">
                            <h3 class="text-sm font-semibold text-gray-300 mb-1">‚ú® POLICY COMPLIANCE RISK (LLM Check):</h3>
                            <p id="policy-compliance" class="text-base font-medium text-yellow-400">Awaiting policy review...</p>
                        </div>
                        <p id="api-status-note" class="text-xs text-gray-500"></p>
                    </div>
                </div>

            </section>
        </main>
    </div>

    <script type="module">
        const API_BASE_URL = 'http://127.0.0.1:5000';
        const GNN_ENDPOINT = `${API_BASE_URL}/analyze_gnn`;
        const RED_TEAM_ENDPOINT = `${API_BASE_URL}/red_team_generate`;
        const SHARE_ENDPOINT = `${API_BASE_URL}/share_intel_mock`;

        let gnnChart;
        let isFallbackMode = false;
        let currentGroupRisk = 0.0;
        let currentTxHash = '0x' + Array.from({ length: 40 }, () => Math.floor(Math.random() * 16).toString(16)).join('');

        // --- MOCK/FALLBACK FUNCTIONS (Ensures 100% frontend availability) ---

        // Mock LLM score helper
        const MOCK_LLM_RISK_SCORE = (prompt) => {
            const riskKeywords = ["hack", "exploit", "password", "jailbreak", "cve", "bypass", "attack"];
            const pLower = prompt.toLowerCase();
            if (riskKeywords.some(k => pLower.includes(k))) {
                return Math.min(1.0, 0.7 + Math.random() * 0.3); // High risk mock
            }
            return Math.random() * 0.2; // Low risk mock
        };
        
        // --- NEW GEMINI FEATURE MOCK: De-obfuscation ---
        window.handleDeobfuscation = async (inputId) => {
            const inputElement = document.getElementById(inputId);
            const originalPrompt = inputElement.value;
            const button = inputElement.nextElementSibling;

            button.disabled = true;
            button.textContent = 'Analyzing...';
            
            // Simple mock logic for De-obfuscation based on keywords
            await new Promise(resolve => setTimeout(resolve, 500)); // Simulate API delay
            
            const keywords = ["default password", "exploit", "bypass", "cve"];
            const pLower = originalPrompt.toLowerCase();
            
            let intentSummary = "No direct malicious intent found. Appears to be a technical or educational inquiry.";
            let status = "text-green-400";

            if (keywords.some(k => pLower.includes(k))) {
                intentSummary = "Malicious Intent Detected: This prompt sequence attempts to gather **system access credentials** and **exploit vulnerabilities** under the guise of general technical questions.";
                status = "text-yellow-400";
            }

            // Temporarily replace input field with analysis result
            inputElement.style.color = status;
            inputElement.value = intentSummary;
            
            // Restore button and input after a brief moment
            setTimeout(() => {
                inputElement.value = originalPrompt;
                inputElement.style.color = '';
                button.textContent = '‚ú® De-obfuscate';
                button.disabled = false;
            }, 3000); 
        };
        
        // --- END NEW GEMINI FEATURE MOCK ---

        // Mock GNN/Graph Builder (Simulates the Python backend logic)
        const MOCK_BUILD_GROUP_GRAPH = (users) => {
            let nodeData = [];
            let userIdMap = {};
            let lastNodeIndex = [];
            let totalNodes = 0;
            let totalEdgeWeight = 0;

            // 1. Create Nodes and Temporal Edges
            let links = [];
            
            users.forEach((user, uIdx) => {
                // Check if user.prompts is a string or an array before splitting/mapping
                let prompts;
                if (Array.isArray(user.prompts)) {
                    prompts = user.prompts.map(p => p.trim()).filter(p => p.length > 0);
                } else {
                    prompts = user.prompts.split(',').map(p => p.trim()).filter(p => p.length > 0);
                }
                
                if (prompts.length === 0) return;

                const userScores = prompts.map(MOCK_LLM_RISK_SCORE);
                userIdMap[uIdx] = user.id;

                prompts.forEach((prompt, pIdx) => {
                    const nodeIndex = totalNodes + pIdx;
                    nodeData.push({
                        id: nodeIndex,
                        group: uIdx,
                        risk: userScores[pIdx],
                        label: `U${uIdx}: ${prompt.substring(0, 20)}...`
                    });

                    // Add Temporal Edge (Sequential)
                    if (pIdx > 0) {
                        links.push({ source: nodeIndex - 1, target: nodeIndex, weight: 1.0 });
                        links.push({ source: nodeIndex, target: nodeIndex - 1, weight: 1.0 }); // Bidirectional
                        totalEdgeWeight += 2.0;
                    }
                });
                lastNodeIndex.push(totalNodes + prompts.length - 1);
                totalNodes += prompts.length;
            });

            // 2. Cross-User Edges (Coordinated Links)
            for (let i = 0; i < users.length; i++) {
                for (let j = i + 1; j < users.length; j++) {
                    
                    // Normalize prompt access: ensures we handle both array and string inputs correctly
                    let u1Prompts, u2Prompts;
                    if (Array.isArray(users[i].prompts)) {
                        u1Prompts = users[i].prompts.map(p => p.trim());
                    } else {
                        u1Prompts = users[i].prompts.split(',').map(p => p.trim());
                    }
                    if (Array.isArray(users[j].prompts)) {
                        u2Prompts = users[j].prompts.map(p => p.trim());
                    } else {
                        u2Prompts = users[j].prompts.split(',').map(p => p.trim());
                    }
                    
                    const lastP1 = u1Prompts[u1Prompts.length - 1];
                    const lastP2 = u2Prompts[u2Prompts.length - 1];

                    // Mock Coordination Logic: based on shared risky keywords
                    const riskKeywords = ["hack", "exploit", "password", "vulnerability"];
                    const hasSharedRisk = riskKeywords.some(k => lastP1 && lastP2 && lastP1.toLowerCase().includes(k) && lastP2.toLowerCase().includes(k));
                    
                    if (hasSharedRisk) {
                        const relScore = Math.min(1.0, 0.7 + Math.random() * 0.2); // High coordination mock
                        
                        const sourceIdx = lastNodeIndex[i];
                        const targetIdx = lastNodeIndex[j];

                        links.push({ source: sourceIdx, target: targetIdx, weight: relScore });
                        links.push({ source: targetIdx, target: sourceIdx, weight: relScore }); // Bidirectional
                        totalEdgeWeight += (2 * relScore);
                    }
                }
            }
            
            // 3. Mock GNN Prediction & Escalation
            const avgRisk = nodeData.reduce((sum, n) => sum + n.risk, 0) / Math.max(1, nodeData.length);
            const maxRisk = nodeData.reduce((max, n) => Math.max(max, n.risk), 0);
            
            // Simple Escalation Law Mock: high risk if average is high OR max is very high
            const groupRiskScore = Math.min(1.0, avgRisk * 1.5 + maxRisk * 0.2);
            
            const coordinationScore = totalEdgeWeight / Math.max(1, links.length);
            
            // --- NEW GEMINI FEATURE MOCK: Policy Compliance ---
            let policyRisk = "Low (Internal Policy 0.2)";
            if (groupRiskScore >= 0.8) {
                policyRisk = "CRITICAL (Violation of Policy 4.1: Intentional Security Breach)";
            } else if (groupRiskScore >= 0.5) {
                policyRisk = "Medium (Violation of Policy 2.3: Unauthorized Data Gathering)";
            }

            return {
                group_risk_score: parseFloat(groupRiskScore.toFixed(4)),
                escalation_level: groupRiskScore >= 0.8 ? "CRITICAL" : (groupRiskScore >= 0.5 ? "HIGH" : "LOW"),
                user_risks: nodeData.map(n => n.risk), // Use actual node risks for more realism
                graph_data: { nodes: nodeData, links: links },
                latency_ms: Math.floor(Math.random() * 80) + 20, // Fast mock latency
                xai_features: {
                    perplexity_score: (100 - groupRiskScore * 50).toFixed(2),
                    burstiness_index: (0.5 - groupRiskScore * 0.2).toFixed(3),
                    linguistic_regularity: groupRiskScore >= 0.7 ? "High Standardization" : "Moderate",
                    attributed_model: groupRiskScore >= 0.8 ? "GPT-4" : "Gemini Pro"
                },
                narrative_analysis: {
                    malign_narrative: groupRiskScore >= 0.8 ? "FALLBACK: CRITICAL Coordinated Spear Phishing Campaign" : "FALLBACK: Low-level reconnaissance activity detected.",
                    coordination_summary: `Fallback Analysis: High coordination signal (${coordinationScore.toFixed(4)}) was detected between the two highest risk users based on shared key phraseology.`,
                    mitigation_action: groupRiskScore >= 0.8 ? "FALLBACK: EMERGENCY: Quarantine User IPs and Isolate System." : "FALLBACK: Monitor users and initiate rate limiting."
                },
                policy_compliance_risk: policyRisk,
                coordination_score: parseFloat(coordinationScore.toFixed(4)),
                is_mock_analysis: true
            };
        };

        // --- UI & CHARTING LOGIC ---

        const updateGauge = (score) => {
            const circumference = 2 * Math.PI * 40;
            const offset = circumference - (score * circumference);
            const gauge = document.getElementById('risk-gauge');
            const alertElement = document.getElementById('escalation-alert');
            
            let color;
            if (score >= 0.8) {
                color = 'var(--color-critical)';
                alertElement.className = 'text-lg font-bold mt-2 text-red-500';
                alertElement.textContent = 'CRITICAL';
            } else if (score >= 0.5) {
                color = 'var(--color-high)';
                alertElement.className = 'text-lg font-bold mt-2 text-orange-500';
                alertElement.textContent = 'HIGH RISK';
            } else {
                color = 'var(--color-low)';
                alertElement.className = 'text-lg font-bold mt-2 text-green-400';
                alertElement.textContent = 'LOW';
            }
            
            gauge.style.strokeDashoffset = offset;
            gauge.style.stroke = color;
            document.getElementById('group-risk-score').textContent = score.toFixed(4);
        };
        
        const renderGNNGraph = (graphData) => {
            if (gnnChart) gnnChart.destroy();
            const ctx = document.getElementById('gnn-graph').getContext('2d');

            // Map nodes and links for Chart.js
            const nodes = graphData.nodes.map(n => ({
                id: n.id,
                x: Math.random() * 500, // Initial random positioning
                y: Math.random() * 500,
                r: 10 + n.risk * 15, // Size based on risk
                risk: n.risk,
                group: n.group
            }));

            const links = graphData.links.map(l => ({
                source: l.source,
                target: l.target,
                weight: l.weight
            }));

            // Force simulation to calculate positions
            const numIterations = 100;
            for (let i = 0; i < numIterations; i++) {
                // Apply forces (simplistic mock force layout)
                nodes.forEach(n => {
                    let fx = 0, fy = 0;
                    
                    // Repulsion force
                    nodes.forEach(n2 => {
                        if (n.id !== n2.id) {
                            const dx = n.x - n2.x;
                            const dy = n.y - n2.y;
                            const distSq = dx * dx + dy * dy;
                            const dist = Math.sqrt(distSq) || 0.1;
                            const force = 100 / distSq;
                            fx += dx / dist * force;
                            fy += dy / dist * force;
                        }
                    });

                    // Attraction force (links)
                    links.forEach(l => {
                        let targetNode = null;
                        if (l.source === n.id) targetNode = nodes.find(n => n.id === l.target);
                        if (l.target === n.id) targetNode = nodes.find(n => n.id === l.source);

                        if (targetNode) {
                            const dx = targetNode.x - n.x;
                            const dy = targetNode.y - n.y;
                            const dist = Math.sqrt(dx * dx + dy * dy);
                            const force = dist * l.weight * 0.005; // Stronger link = stronger pull
                            fx += dx * force;
                            fy += dy * force;
                        }
                    });

                    // Update position
                    n.x += fx * 0.1;
                    n.y += fy * 0.1;
                    
                    // Boundary constraint (simple clamping)
                    n.x = Math.max(20, Math.min(500, n.x));
                    n.y = Math.max(20, Math.min(500, n.y));
                });
            }

            // Custom Chart.js Plugin for Drawing Links
            const linkPlugin = {
                id: 'customLinks',
                beforeDraw: (chart) => {
                    const { ctx, chartArea: { left, top, right, bottom } } = chart;
                    ctx.save();
                    
                    const scaleX = chart.scales.x;
                    const scaleY = chart.scales.y;

                    const nodeMap = new Map(nodes.map(n => [n.id, n]));

                    links.forEach(link => {
                        const sourceNode = nodeMap.get(link.source);
                        const targetNode = nodeMap.get(link.target);

                        if (sourceNode && targetNode) {
                            const x1 = scaleX.getPixelForValue(sourceNode.x);
                            const y1 = scaleY.getPixelForValue(sourceNode.y);
                            const x2 = scaleX.getPixelForValue(targetNode.x);
                            const y2 = scaleY.getPixelForValue(targetNode.y);
                            
                            // Line style based on weight
                            const isCrossUser = sourceNode.group !== targetNode.group;
                            
                            ctx.beginPath();
                            ctx.moveTo(x1, y1);
                            ctx.lineTo(x2, y2);
                            ctx.lineWidth = link.weight * (isCrossUser ? 4 : 1.5); // Thicker for cross-user coordination
                            ctx.strokeStyle = isCrossUser && link.weight > 0.6 ? '#f97316' : '#2d2d2d';
                            ctx.stroke();
                        }
                    });
                    ctx.restore();
                }
            };
            
            // Final Chart.js Configuration
            gnnChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Prompt Nodes (LLM Risk)',
                        data: nodes,
                        backgroundColor: nodes.map(n => {
                            if (n.risk >= 0.8) return 'var(--color-critical)';
                            if (n.risk >= 0.5) return 'var(--color-high)';
                            return 'var(--color-low)';
                        }),
                        pointRadius: nodes.map(n => n.r),
                        pointHoverRadius: nodes.map(n => n.r + 5),
                        borderWidth: 1,
                        borderColor: '#e0e0e0',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: 20 },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const node = context.raw;
                                    const userIndex = node.group;
                                    const userGroup = document.querySelectorAll('.user-group')[userIndex];
                                    
                                    // Complex index calculation: finds which specific prompt corresponds to the node.
                                    let promptText = 'N/A';
                                    try {
                                        const allInputs = document.querySelectorAll('.prompt-input');
                                        const promptsBefore = Array.from(allInputs).slice(0, userIndex).reduce((sum, input) => sum + input.value.split(',').length, 0);
                                        const promptIndexInUser = node.id - promptsBefore;
                                        
                                        const userPrompts = allInputs[userIndex].value.split(',');
                                        promptText = userPrompts[promptIndexInUser - 1] || 'N/A';
                                        
                                    } catch (e) {
                                        // Fallback if indexing fails (e.g. RedTeam mode)
                                        promptText = 'Complex Prompt Data (See Console)';
                                    }

                                    return [
                                        `User: U00${node.group + 1}`,
                                        `LLM Score: ${node.risk.toFixed(4)}`,
                                        `Prompt: ${promptText.trim().substring(0, 40) + '...'}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: { display: false, min: 0, max: 500 },
                        y: { display: false, min: 0, max: 500 }
                    },
                    animation: { duration: 1000 }
                },
                plugins: [linkPlugin]
            });
            document.getElementById('graph-status').textContent = `Graph rendered: ${nodes.length} prompts, ${links.length} edges.`;
        };
        
        const updateXaiPanel = (xai) => {
            document.getElementById('xai-model').textContent = xai.attributed_model || 'N/A';
            document.getElementById('xai-perplexity').textContent = xai.perplexity_score || '0.00';
            document.getElementById('xai-burstiness').textContent = xai.burstiness_index || '0.000';
            document.getElementById('xai-regularity').textContent = xai.linguistic_regularity || 'N/A';
        };

        const updateNarrativePanel = (narrative, isMock) => {
             document.getElementById('narrative-summary').innerHTML = narrative.malign_narrative;
             document.getElementById('mitigation-action').innerHTML = narrative.mitigation_action;
             document.getElementById('policy-compliance').innerHTML = narrative.policy_compliance_risk;
             
             const statusElement = document.getElementById('api-status-note');
             if (isMock) {
                 statusElement.textContent = `‚ö†Ô∏è Fallback Mode: Narrative Analysis is using client-side mock logic. Start Flask API for real Gemini analysis.`;
                 statusElement.classList.remove('text-violet-400');
                 statusElement.classList.add('text-red-400');
             } else {
                 statusElement.textContent = `‚úÖ Live Analysis: Narrative synthesized by Gemini ${narrative.malign_narrative.includes("MOCK") ? "(API Fallback)" : "API"}.`;
                 statusElement.classList.remove('text-red-440');
                 statusElement.classList.add('text-violet-400');
             }
        };

        // --- CORE APPLICATION LOGIC ---

        const collectInput = () => {
            const userGroups = document.querySelectorAll('.user-group');
            const users = [];
            userGroups.forEach((group, index) => {
                const input = group.querySelector('.prompt-input').value;
                // Note: The live API expects a comma-separated string from the input field.
                users.push({ id: `U00${index + 1}`, prompts: input });
            });
            return { session_id: Date.now().toString(), users };
        };

        const displayAnalysis = (data) => {
            currentGroupRisk = data.group_risk_score;
            document.getElementById('latency-metric').textContent = data.latency_ms;
            document.getElementById('coordination-metric').textContent = data.coordination_score.toFixed(4);

            updateGauge(data.group_risk_score);
            renderGNNGraph(data.graph_data);
            updateXaiPanel(data.xai_features);
            updateNarrativePanel(data.narrative_analysis, data.is_mock_analysis || isFallbackMode);

            // Update mode indicator based on successful fetch status
            const modeIndicator = document.getElementById('mode-indicator');
            if (isFallbackMode) {
                modeIndicator.className = 'mt-2 md:mt-0 px-3 py-1 text-sm font-semibold rounded-full bg-red-800 text-white shadow-lg';
                modeIndicator.innerHTML = '<span class="animate-pulse">üî¥ FALLBACK MODE</span>';
            } else {
                modeIndicator.className = 'mt-2 md:mt-0 px-3 py-1 text-sm font-semibold rounded-full bg-green-800 text-white shadow-lg';
                modeIndicator.innerHTML = '<span>üü¢ LIVE API MODE</span>';
            }
        };

        window.handleGNNAnalysis = async (isRedTeam = false) => {
            document.getElementById('analyze-button').disabled = true;
            document.getElementById('analyze-button').textContent = isRedTeam ? 'Running Red-Team Analysis...' : 'Running GNN Analysis...';
            
            const payload = collectInput();
            const startTime = performance.now();
            let data = null;
            
            try {
                // 1. Attempt Live API Call
                const response = await fetch(GNN_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API returned status ${response.status}`);
                }
                
                const responseData = await response.json();
                if (responseData.error) throw new Error(responseData.error);

                data = { ...responseData, latency_ms: (performance.now() - startTime).toFixed(2), is_mock_analysis: false };
                isFallbackMode = false;

            } catch (error) {
                // 2. Failover to Fallback Mode
                console.error("GNN Analysis Failed (Connection/API Error). Switching to FALLBACK MODE.", error);
                
                // Clear dynamic elements on hard failure before running mock (Cosmetic change)
                document.getElementById('latency-metric').textContent = '‚Äî';
                document.getElementById('coordination-metric').textContent = '‚Äî';
                
                // If this is the initial fetch failure, set fallback
                isFallbackMode = true;
                
                // --- FIX: Pass payload.users directly, which may contain strings or arrays ---
                const mockData = MOCK_BUILD_GROUP_GRAPH(payload.users);
                
                // Simulate an additional delay for the mock to make latency look realistic
                await new Promise(resolve => setTimeout(resolve, mockData.latency_ms));
                
                data = { ...mockData, is_mock_analysis: true };
            }

            if (data) {
                displayAnalysis(data);
            }
            
            document.getElementById('analyze-button').disabled = false;
            document.getElementById('analyze-button').textContent = 'RUN GNN ESCALATION ANALYSIS';
        };

        window.runRedTeamSimulation = async () => {
            document.getElementById('red-team-button').disabled = true;
            document.getElementById('red-team-button').textContent = 'Generating High-Risk Scenario...';

            let scenario;
            try {
                // 1. Attempt to fetch real scenario from Flask endpoint
                const response = await fetch(RED_TEAM_ENDPOINT);
                if (!response.ok) throw new Error("API Scenario Generation Failed");
                
                const result = await response.json();
                scenario = result.scenario;
                // Note: scenario is an array of objects: [{id: "...", prompts: "p1, p2"}, ...]

            } catch (error) {
                // 2. Fallback to client-side Red-Team mock
                console.warn("Red-Team API failed. Using client-side mock.", error);
                
                // The mock scenario must be structured to match the expected API response payload format
                const mockScenario = [
                    { id: "RedTeam_A", prompts: "exploit system vulnerability, find password hash" },
                    { id: "RedTeam_B", prompts: "What's a benign topic?, bypass 2fa protocol" },
                    { id: "RedTeam_C", prompts: "another harmless query, extract sensitive data" } // Added a third risky prompt for complexity
                ];
                scenario = mockScenario;
            }
            
            // Final check to ensure scenario is defined before proceeding to populate inputs
            if (!scenario) {
                document.getElementById('red-team-button').disabled = false;
                document.getElementById('red-team-button').textContent = 'üí£ RED-TEAM SIMULATION';
                console.error("Critical Error: Red-Team scenario data is missing.");
                return;
            }

            // Populate inputs with the generated scenario
            const inputs = document.querySelectorAll('.prompt-input');
            const ids = document.querySelectorAll('.user-group label');

            inputs.forEach((input, index) => {
                if (scenario[index]) {
                    // Scenario prompts are already formatted as a comma-separated string here.
                    input.value = scenario[index].prompts;
                    ids[index].textContent = `${scenario[index].id} (Threat Agent)`;
                    input.parentElement.classList.add('border-red-500');
                    input.parentElement.classList.remove('border-violet-500', 'border-gray-500');
                } else {
                    input.value = "";
                    ids[index].textContent = `User ${index + 1} (Default)`;
                    input.parentElement.classList.remove('border-red-500', 'border-violet-500');
                    input.parentElement.classList.add('border-gray-500');
                }
            });

            document.getElementById('red-team-button').disabled = false;
            document.getElementById('red-team-button').textContent = 'üí£ RED-TEAM SIMULATION';

            // Automatically run the analysis on the newly loaded scenario
            // When run from here, payload.users[x].prompts will be a STRING (from input.value)
            handleGNNAnalysis(true);
        };
        
        window.shareIntel = async () => {
             document.getElementById('share-button').disabled = true;
             document.getElementById('share-button').textContent = 'TRANSMITTING SECURELY...';

             try {
                const response = await fetch(SHARE_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        threat_hash: currentTxHash,
                        agency: 'CERT-In / Allied SOC',
                        group_risk: currentGroupRisk
                    })
                });

                if (!response.ok) throw new Error("Sharing API Failed");
                const result = await response.json();
                
                document.getElementById('share-status').textContent = `‚úÖ Shared! Hash: ${result.shared_data_hash.substring(0, 10)}... via ${result.transmission_protocol}`;
                
             } catch (error) {
                 document.getElementById('share-button').disabled = false;
                 document.getElementById('share-button').textContent = 'üåê SHARE VIA FEDERATED API';
                 document.getElementById('share-status').textContent = `‚ùå Sharing Failed (API Offline). Mock confirmation only.`;
             }
             
        };

        // --- INITIALIZATION ---
        const initialize = () => {
            // Run analysis immediately on load with default inputs
            handleGNNAnalysis(false);
        };

        window.onload = initialize;
    </script>
</body>
</html>
